<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Radial Job Salary Visualization</title>
<script src="https://d3js.org/d3.v7.min.js">
function rotateLabelTowardCenter(x, y, cx, cy) {
    const dx = x - cx;
    const dy = y - cy;
    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
    return angle;
}


// === Injected: Extract actual cx/cy from circle and assign to node data ===
</script>
<style>
    :root {
      --base-font-size: 16px;
      --base-spacing: 1rem;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #ffffff;
      margin: 0;
      padding: 0;
      font-size: var(--base-font-size);
      overflow-x: hidden;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .visualization-container {
      position: relative;
      width: 100%;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    svg {
      background: #ffffff;
      max-width: 100%;
      height: 100vh;
      display: block;
    }

    .link {
      stroke-width: 1px;
      fill: none;
      opacity: 0.15;
    }
    .node text {
      font-size: calc(var(--base-font-size) * 0.5);
      text-anchor: middle;
      dominant-baseline: middle;
    }
  



.node:hover {
  cursor: pointer;
}

.tooltip {
  position: absolute;
  padding: calc(var(--base-spacing) * 0.5);
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid #ddd;
  border-radius: 4px;
  pointer-events: none;
  font-size: calc(var(--base-font-size) * 0.75);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  z-index: 1000;
}

.custom-alert {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: calc(var(--base-spacing) * 1.25) calc(var(--base-spacing) * 1.875);
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  z-index: 1000;
  text-align: center;
  display: none;
  max-width: 90%;
  width: auto;
}

.custom-alert p {
  margin: 0 0 calc(var(--base-spacing) * 0.9375) 0;
  font-size: calc(var(--base-font-size) * 0.875);
}

.custom-alert button {
  padding: calc(var(--base-spacing) * 0.5) calc(var(--base-spacing) * 1.25);
  background: #ffb6c1;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  color: white;
}

.custom-alert button:hover {
  background: #ff9fad;
}

.salary-info, .visualization-info {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  padding: calc(var(--base-spacing) * 0.5);
  background: rgba(255, 255, 255, 0.15);
  font-size: calc(var(--base-font-size) * 0.75);
  text-align: center;
  pointer-events: none;
  width: 90%;
  max-width: 600px;
  line-height: 1.6;
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.salary-info {
  bottom: 20px;
}

.visualization-info {
  top: 80px;
}

.legend {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(255, 255, 255, 0.95);
  padding: calc(var(--base-spacing) * 0.625);
  font-size: calc(var(--base-font-size) * 0.625);
  line-height: 1.4;
  text-align: left;
  max-width: 200px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.legend-item {
  display: flex;
  align-items: center;
  margin-bottom: 5px;
}

.legend-color {
  width: 12px;
  height: 12px;
  margin-right: 8px;
  border-radius: 50%;
}

.job-modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: calc(var(--base-spacing) * 1.25);
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  z-index: 1000;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
}

.job-modal-content {
  margin: 15px 0;
}

.job-modal-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 15px;
  color: #333;
}

.job-modal-section {
  margin: 15px 0;
  padding-bottom: 15px;
  border-bottom: 1px solid #eee;
}

.job-modal-section:last-child {
  border-bottom: none;
}

.job-modal-section-title {
  font-weight: bold;
  color: #666;
  margin-bottom: 8px;
}

.close-modal {
  position: absolute;
  top: 10px;
  right: 10px;
  cursor: pointer;
  font-size: 20px;
  color: #666;
}

.close-modal:hover {
  color: #333;
}

@media screen and (max-width: 768px) {
  :root {
    --base-font-size: 14px;
  }

  .legend {
    position: fixed;
    top: 50px;
    right: 10px;
    margin: 0;
    max-width: 150px;
    font-size: calc(var(--base-font-size) * 0.5);
  }

  .salary-info, .visualization-info {
    position: fixed;
    width: 85%;
    max-width: 400px;
    font-size: calc(var(--base-font-size) * 0.65);
    padding: calc(var(--base-spacing) * 0.3);
  }

  .salary-info {
    bottom: 10px;
  }

  .visualization-info {
    top: 60px;
  }
}

@media screen and (max-height: 600px) {
  .salary-info {
    bottom: 5px;
  }

  .visualization-info {
    top: 5px;
  }
}

@media screen and (min-width: 1920px) {
  :root {
    --base-font-size: 18px;
  }
}
</style>
</head>
<body>
<div class="visualization-container">
    <svg height="100%" id="visualization" width="100%" viewBox="0 0 1000 700" preserveAspectRatio="xMidYMid meet"></svg>
    <div id="customAlert" class="custom-alert">
        <p id="alertMessage"></p>
        <button onclick="closeAlert()">OK</button>
    </div>
    <div id="salaryInfo" class="salary-info"></div>
    <div id="visualizationInfo" class="visualization-info"></div>
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #90EE90; opacity: 0.3;"></div>
            <span>Countries</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffb6c1; opacity: 0.3;"></div>
            <span>Job Positions (sorted by salary: up→down)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #a88fdd; opacity: 0.55;"></div>
            <span>Years (2020-2024)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(255,255,255,0.7);"></div>
            <span>Navigation Arrows (⮌ ⮎)</span>
        </div>
    </div>
</div>
<div id="jobModal" class="job-modal">
  <span class="close-modal" onclick="closeJobModal()">×</span>
  <div class="job-modal-content"></div>
</div>
<script>
const svg = d3.select("#visualization");
const centerX = 500, centerY = 350;
const radiusJob = 320;
const radiusCountry = 320;

const years = ["2020", "2021", "2022", "2023", "2024"];
const countries = ["US", "GB", "IN", "DE", "FR", "AU", "ES", "NL", "BR", "CA"];

// === 初始化变量 ===
let selectedCountry = "GB";
let selectedYear = "2024";
let currentYearIndex = years.indexOf(selectedYear);
let jobPageIndex = 0;
let totalJobPages = 1;
let jobDataFull = {};
const jobsPerPage = 10;
let jobNodes;
let jobAngles;
let currentJobs = [];  // 用于存储当前显示的职位数据
let jobDescriptions = {};

function polarToCartesian(cx, cy, radius, angle) {
  const rad = (angle - 90) * Math.PI / 180;
  return {
    x: cx + radius * Math.cos(rad),
    y: cy + radius * Math.sin(rad)
  };
}

// COUNTRIES: bottom half
const countryAngles = d3.scalePoint().domain(countries).range([150, 30]);

const countryNames = {
  "US": "United States",
  "GB": "Great Britain",
  "IN": "India",
  "DE": "Germany",
  "FR": "France",
  "AU": "Australia",
  "ES": "Spain",
  "NL": "Netherlands",
  "BR": "Brazil",
  "CA": "Canada"
};

const countryNodes = svg.selectAll(".country")
  .data(countries)
  .enter()
  .append("g")
  .attr("class", "node country")
  .attr("transform", d => {
    const pos = polarToCartesian(centerX, centerY, radiusCountry, countryAngles(d));


    return `translate(${pos.x}, ${pos.y})`;
  });

countryNodes.append("circle")
  .attr("r", 32)
  .attr("fill", "#90EE90")
  .attr("stroke", "#90EE90")
  .attr("stroke-width", 1)
  .attr("stroke-opacity", 0.15)
  .attr("opacity", 0.3)
  .attr("data-original-stroke", "#90EE90")
  .attr("data-original-stroke-width", 1);

// 修改 Country 标签的旋转逻辑
countryNodes.append("text")
  .attr("fill", "#444")
  .attr("font-size", "8px")
  .attr("text-anchor", "start")
  .attr("dominant-baseline", "middle")
  .attr("transform", d => {
    const pos = polarToCartesian(centerX, centerY, radiusCountry, countryAngles(d));
    const angle = Math.atan2(pos.y - centerY, pos.x - centerX) * 180 / Math.PI;
    const rotation = angle;
    const offset = 33;
    return `rotate(${rotation}) translate(${offset}, 0)`;
  })
  .text(d => countryNames[d] || d);




// YEARS: center
// 年份节点显示用的颜色映射
const yearColors = {
  "2020": "#a88fdd",
  "2021": "#a88fdd",
  "2022": "#a88fdd",
  "2023": "#a88fdd",
  "2024": "#a88fdd"
};

// 背景圆圈使用的颜色映射
const backgroundYearColors = {
  "2020": "#f7e463",
  "2021": "#fdb567",
  "2022": "#f27ca5",
  "2023": "#a88fdd",
  "2024": "#91d3a2"
};

// 获取交互节点的保护区域
let protectedZones = [];

// 判断是否在排除区域（弧形 + 中轴）
function isInExcludedRegion(x, y) {
  const dx = x - centerX;
  const dy = y - centerY;
  const dist = Math.sqrt(dx * dx + dy * dy);
  const angle = Math.atan2(dy, dx) * 180 / Math.PI;
  const angleDeg = (angle + 360) % 360;

  // 主要可视化区域半径
  const visualizationRadius = 380;
  
  // 检查是否在主要可视化区域内
  return dist < visualizationRadius;
}

// 更新保护区域
function updateProtectedZones() {
  protectedZones = [];
  d3.selectAll(".node").each(function() {
    const transform = d3.select(this).attr("transform");
    const match = /translate\(([^,]+),([^\)]+)\)/.exec(transform);
    if (match) {
      const x = +match[1];
      const y = +match[2];
      protectedZones.push({ x, y, r: 35 }); // 半径缓冲区
    }
  });
}

// 判断是否与节点区域重叠
function isOverlappingProtectedZone(x, y) {
  return protectedZones.some(zone => {
    const dx = x - zone.x;
    const dy = y - zone.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    return dist < zone.r + 10;  // background radius buffer
  });
}

function generateValidPosition() {
  let x, y;
  do {
    x = Math.random() * 1000;
    y = Math.random() * 700;
  } while (isInExcludedRegion(x, y));
  
  return { x, y };
}

// 修改生成背景圆圈的函数
function generateBackgroundCircles() {
  const backgroundColors = Object.values(backgroundYearColors);
  updateProtectedZones(); // 确保在生成背景圆圈前更新保护区域

  // 生成小圆圈
  for (let i = 0; i < 300; i++) {
    const pos = generateValidPosition();
    const color = backgroundColors[Math.floor(Math.random() * backgroundColors.length)];
    if (!isOverlappingProtectedZone(pos.x, pos.y)) {
      svg.append("circle")
        .attr("class", "bg-circle")
        .attr("cx", pos.x)
        .attr("cy", pos.y)
        .attr("r", 0)
        .attr("fill", color)
        .attr("opacity", 0.2)
        .transition()
        .duration(800)
        .attr("r", Math.random() * 8 + 4);
    }
  }

  // 生成大圆圈
  for (let i = 0; i < 30; i++) {
    const pos = generateValidPosition();
    const color = backgroundColors[Math.floor(Math.random() * backgroundColors.length)];
    if (!isOverlappingProtectedZone(pos.x, pos.y)) {
      svg.append("circle")
        .attr("class", "bg-circle")
        .attr("cx", pos.x)
        .attr("cy", pos.y)
        .attr("r", 0)
        .attr("fill", color)
        .attr("opacity", 0.2)
        .transition()
        .duration(1000)
        .attr("r", Math.random() * 35 + 15);
    }
  }
}

// 背景圆圈重绘函数
function regenerateBackgroundCircles() {
  updateProtectedZones();
  svg.selectAll(".bg-circle").remove();
  generateBackgroundCircles();
}

// Add left and right toggle circles
const arrowRadius = 24;
const arrowFill = "#ff9900";

// 设置箭头控制圆圈颜色和大小
const arrowControlRadius = 22;
const arrowControlColor = "rgba(255,255,255,0.7)";  // 白色透明

// 圆心位置
const year2020Pos = { x: centerX, y: centerY + (-2 * 75) };
const yearRadius = 20;

// 左箭头圆圈（350°）
const leftArrowPos = polarToCartesian(centerX, centerY, radiusJob, 350);
const arrowLeft = svg.append("g")
  .attr("class", "arrow-control left")
  .attr("transform", `translate(${leftArrowPos.x}, ${leftArrowPos.y})`)
  .style("cursor", "pointer");

arrowLeft.append("circle")
  .attr("r", arrowControlRadius)
  .attr("fill", arrowControlColor)
  .attr("stroke", "#000000")
  .attr("stroke-opacity", 0.15)
  .attr("stroke-width", 1);

arrowLeft.append("text")
  .attr("text-anchor", "middle")
  .attr("dy", "0.35em")
  .attr("fill", "black")
  .attr("font-size", "22px")
  .text("⮌");  // 圆弧箭头左

arrowLeft.on("click", () => {
  if (jobPageIndex === 0) {
    showCustomAlert("This is the first page of job listings.");
    return;
  }
  jobPageIndex = (jobPageIndex - 1 + totalJobPages) % totalJobPages;
  updateJobNodes();
  // 重新生成背景圆圈
  regenerateBackgroundCircles();
});

// 右箭头圆圈（10°）
const rightArrowPos = polarToCartesian(centerX, centerY, radiusCountry, 10);
const arrowRight = svg.append("g")
  .attr("class", "arrow-control right")
  .attr("transform", `translate(${rightArrowPos.x}, ${rightArrowPos.y})`)
  .style("cursor", "pointer");

arrowRight.append("circle")
  .attr("r", arrowControlRadius)
  .attr("fill", arrowControlColor)
  .attr("stroke", "#000000")
  .attr("stroke-opacity", 0.15)
  .attr("stroke-width", 1);

arrowRight.append("text")
  .attr("text-anchor", "middle")
  .attr("dy", "0.35em")
  .attr("fill", "black")
  .attr("font-size", "22px")
  .text("⮎");  // 圆弧箭头右

arrowRight.on("click", () => {
  if (jobPageIndex === totalJobPages - 1) {
    showCustomAlert("This is the last page of job listings.");
    return;
  }
  jobPageIndex = (jobPageIndex + 1) % totalJobPages;
  updateJobNodes();
  // 重新生成背景圆圈
  regenerateBackgroundCircles();
});

// 工具函数：从A点朝向B点方向偏移r的边缘点
function edgePoint(ax, ay, bx, by, r) {
  const dx = bx - ax;
  const dy = by - ay;
  const dist = Math.sqrt(dx * dx + dy * dy);
  if (dist === 0) return { x: ax, y: ay };
  const ratio = r / dist;
  return { x: ax + dx * ratio, y: ay + dy * ratio };
}

// 画连接线，颜色灰色 (#555555)
const leftStart = edgePoint(year2020Pos.x, year2020Pos.y, leftArrowPos.x, leftArrowPos.y, yearRadius);
const leftEnd = edgePoint(leftArrowPos.x, leftArrowPos.y, year2020Pos.x, year2020Pos.y, arrowControlRadius);
svg.append("line")
  .attr("x1", leftEnd.x)
  .attr("y1", leftEnd.y)
  .attr("x2", leftStart.x)
  .attr("y2", leftStart.y)
  .attr("stroke", "#555555")
  .attr("stroke-width", 1)
  .attr("opacity", 0.15)
  .lower();

const rightStart = edgePoint(year2020Pos.x, year2020Pos.y, rightArrowPos.x, rightArrowPos.y, yearRadius);
const rightEnd = edgePoint(rightArrowPos.x, rightArrowPos.y, year2020Pos.x, year2020Pos.y, arrowControlRadius);
svg.append("line")
  .attr("x1", rightEnd.x)
  .attr("y1", rightEnd.y)
  .attr("x2", rightStart.x)
  .attr("y2", rightStart.y)
  .attr("stroke", "#555555")
  .attr("stroke-width", 1)
  .attr("opacity", 0.15)
  .lower();

const yearNodes = svg.selectAll(".year")
  .data(years)
  .enter()
  .append("g")
  .attr("class", "node year")
  .attr("transform", (d, i) => `translate(${centerX}, ${centerY + (i - 2) * 75})`);

yearNodes.append("circle").attr("r", 20).attr("fill", d => yearColors[d] || "#555555")
  .attr("opacity", 0.55);
yearNodes.append("text")
  .text(d => d)
  .attr("fill", "black");


function adjustToCircleEdge(source, target, radius) {
  const dx = target.x - source.x;
  const dy = target.y - source.y;
  const dist = Math.sqrt(dx * dx + dy * dy);
  if (dist === 0) return source;
  const ratio = radius / dist;
  return {
    x: source.x + dx * ratio,
    y: source.y + dy * ratio
  };
}


// === 更新函数定义 ===
function updateLinkColors() {
  // 先将所有连接线重置为灰色和低透明度
  d3.selectAll(".link")
    .attr("stroke", "#555555")
    .style("opacity", 0.15);
  
  // 1. 高亮被选中国家到年份的连接线（淡粉色）
  d3.selectAll(".link")
    .filter(function() {
      const type = d3.select(this).attr("data-type");
      const country = d3.select(this).attr("data-country");
      return type === "country-link" && country === selectedCountry;
    })
    .attr("stroke", "#ffb6c1")  // 淡粉色 (LightPink)
    .style("opacity", 1);  // 保持选中的线不变
  
  // 2. 高亮被选中年份到职位的连接线（淡粉色）
  d3.selectAll(".link")
    .filter(function() {
      const type = d3.select(this).attr("data-type");
      const year = d3.select(this).attr("data-year");
      return type === "job-link" && year === selectedYear;
    })
    .attr("stroke", "#ffb6c1")  // 淡粉色 (LightPink)
    .style("opacity", 1);  // 保持选中的线不变
}

function updateNodeHighlights() {
  // 清除所有高亮
  d3.selectAll(".node circle")
    .classed("selected", false)
    .attr("stroke", function() { return d3.select(this).attr("data-original-stroke") || "none"; })
    .attr("stroke-width", function() { return d3.select(this).attr("data-original-stroke-width") || 1.2; });

  // 高亮被选中的国家
  d3.selectAll(".node.country")
    .filter(d => d === selectedCountry)
    .select("circle")
    .each(function() {
      const circle = d3.select(this);
      const fill = circle.attr("fill");
      circle
        .attr("stroke", fill)
        .attr("stroke-width", 3);
    });

  // 高亮被选中的年份
  d3.selectAll(".node.year")
    .filter(d => d === selectedYear)
    .select("circle")
    .each(function() {
      const circle = d3.select(this);
      const fill = circle.attr("fill");
      circle
        .attr("stroke", fill)
        .attr("stroke-width", 3);
    });
}

// === 事件监听器绑定 ===
d3.selectAll(".node.country").on("click", function(event, d) {
  selectedCountry = d;
  updateLinkColors();
  updateNodeHighlights();
  updateJobNodes();
  updateSalaryInfo();
});

d3.selectAll(".node.year").on("click", function(event, d) {
  selectedYear = d;
  currentYearIndex = years.indexOf(selectedYear);
  updateLinkColors();
  updateNodeHighlights();
  updateJobNodes();
  updateSalaryInfo();
});


// ==== 新增变量和加载数据 ====

// 在数据加载之前就初始化说明文本
initializeVisualizationInfo();

// 然后再加载数据
Promise.all([
  d3.json("salary_by_year_country_avg.json"),
  d3.json("job_descriptions.json")
]).then(function([salaryData, descriptionsData]) {
  jobDataFull = salaryData;
  
  // 将职位描述数据转换为以职位名称为键的对象
  jobDescriptions = descriptionsData.reduce((acc, curr) => {
    acc[curr.job_title] = curr;
    return acc;
  }, {});
  
  // 获取所有职位
  const allJobs = jobDataFull[selectedYear][selectedCountry] || [];
  
  // 计算总页数
  totalJobPages = Math.ceil(allJobs.length / jobsPerPage);
  
  // 确保 jobPageIndex 在有效范围内
  jobPageIndex = Math.max(0, Math.min(jobPageIndex, totalJobPages - 1));
  
  // 只获取第一页的职位（前10个）
  currentJobs = allJobs.slice(0, jobsPerPage);
  
  // 设置角度比例尺
  jobAngles = d3.scalePoint()
    .domain(currentJobs.map(d => d.title).sort((a, b) => {
        const jobA = currentJobs.find(job => job.title === a);
        const jobB = currentJobs.find(job => job.title === b);
        return jobA.salary - jobB.salary;
    }))
    .range([210, 330]);

  // 创建职位节点
  jobNodes = svg.selectAll(".job")
    .data(currentJobs)
    .enter()
    .append("g")
    .attr("class", "node job")
    .attr("transform", d => {
      const pos = polarToCartesian(centerX, centerY, radiusJob, jobAngles(d.title));
      return `translate(${pos.x}, ${pos.y})`;
    });

  // 添加圆圈
  jobNodes.append("circle")
    .attr("r", 32)  // 固定半径为32
    .attr("fill", "#ffb6c1")
    .attr("stroke", "#ffb6c1")
    .attr("stroke-width", 1)
    .attr("stroke-opacity", 0.15)
    .attr("opacity", 0.3)
    .attr("data-original-stroke", "#ffb6c1")
    .attr("data-original-stroke-width", 1);

  // 添加文本标签
  jobNodes.append("text")
    .attr("fill", "#222")
    .attr("font-size", "8px")
    .attr("text-anchor", "end")
    .attr("dominant-baseline", "middle")
    .attr("transform", d => {
      const pos = polarToCartesian(centerX, centerY, radiusJob, jobAngles(d.title));
      const angle = Math.atan2(pos.y - centerY, pos.x - centerX) * 180 / Math.PI;
      const rotation = angle + 180;
      const offset = -33;
      return `rotate(${rotation}) translate(${offset}, 0)`;
    })
    .text(d => d.title);

  // 设置事件监听器
  jobNodes
    .on("click", function(event, d) {
      showJobDetails(d.title);  // 添加点击事件
    })
    .on("mouseover", function(event, d) {
      const circle = d3.select(this).select("circle");
      circle
        .transition()
        .duration(200)
        .attr("stroke-width", 2)
        .attr("stroke-opacity", 0.5);
      
      tooltip.transition()
        .duration(200)
        .style("opacity", 1);
      
      const formattedSalary = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(d.salary);
      
      tooltip.html(`<strong>${d.title}</strong><br>Average Salary: ${formattedSalary}`)
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", function() {
      const circle = d3.select(this).select("circle");
      circle
        .transition()
        .duration(200)
        .attr("stroke-width", 1)
        .attr("stroke-opacity", 0.15);
      
      tooltip.transition()
        .duration(500)
        .style("opacity", 0);
    });

  // 初始化连接线和高亮
  updateLinks();
  updateLinkColors();
  updateNodeHighlights();
  updateSalaryInfo();
}).catch(function(error) {
  console.error("Error loading the data:", error);
});

// 修改 updateJobNodes 函数，添加分页逻辑
function updateJobNodes() {
  // 获取当前国家和年份的所有职位
  const allJobs = (jobDataFull[selectedYear] && jobDataFull[selectedYear][selectedCountry]) 
    ? jobDataFull[selectedYear][selectedCountry] 
    : [];
    
  // 计算总页数
  totalJobPages = Math.ceil(allJobs.length / jobsPerPage);
  
  // 确保 jobPageIndex 在有效范围内
  jobPageIndex = Math.max(0, Math.min(jobPageIndex, totalJobPages - 1));
  
  // 获取当前页的职位
  const startIndex = jobPageIndex * jobsPerPage;
  currentJobs = allJobs.slice(startIndex, startIndex + jobsPerPage);

  // 更新角度比例尺
  jobAngles = d3.scalePoint()
    .domain(currentJobs.map(d => d.title).sort((a, b) => {
        const jobA = currentJobs.find(job => job.title === a);
        const jobB = currentJobs.find(job => job.title === b);
        return jobA.salary - jobB.salary;
    }))
    .range([210, 330]);

  // 更新节点
  const jobNodes = svg.selectAll(".node.job")
    .data(currentJobs, d => d.title); // 使用 title 作为 key

  // 移除不需要的节点
  jobNodes.exit().remove();

  // 添加新节点
  const jobNodesEnter = jobNodes.enter()
    .append("g")
    .attr("class", "node job");

  jobNodesEnter.append("circle")
    .attr("r", 32)  // 固定半径为32
    .attr("fill", "#ffb6c1")
    .attr("stroke", "#ffb6c1")
    .attr("stroke-width", 1)
    .attr("stroke-opacity", 0.15)
    .attr("opacity", 0.3)
    .attr("data-original-stroke", "#ffb6c1")
    .attr("data-original-stroke-width", 1);

  jobNodesEnter.append("text")
    .attr("fill", "#222")
    .attr("font-size", "8px")
    .attr("text-anchor", "end")
    .attr("dominant-baseline", "middle");

  // 更新所有节点（包括新旧节点）
  const jobNodesUpdate = jobNodesEnter.merge(jobNodes);

  jobNodesUpdate
    .attr("transform", d => {
      const pos = polarToCartesian(centerX, centerY, radiusJob, jobAngles(d.title));
      return `translate(${pos.x}, ${pos.y})`;
    });

  jobNodesUpdate.select("circle")
    .attr("r", 32);

  jobNodesUpdate.select("text")
    .attr("fill", "#222")
    .attr("font-size", "8px")
    .attr("text-anchor", "end")
    .attr("dominant-baseline", "middle")
    .attr("transform", d => {
      const pos = polarToCartesian(centerX, centerY, radiusJob, jobAngles(d.title));
      const angle = Math.atan2(pos.y - centerY, pos.x - centerX) * 180 / Math.PI;
      const rotation = angle + 180;
      const offset = -33;
      return `rotate(${rotation}) translate(${offset}, 0)`;
    })
    .text(d => d.title);

  // 更新事件监听器
  jobNodesUpdate
    .on("click", function(event, d) {
      showJobDetails(d.title);  // 添加点击事件
    })
    .on("mouseover", function(event, d) {
      const circle = d3.select(this).select("circle");
      circle
        .transition()
        .duration(200)
        .attr("stroke-width", 2)
        .attr("stroke-opacity", 0.5);
      
      tooltip.transition()
        .duration(200)
        .style("opacity", 1);
      
      const formattedSalary = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(d.salary);
      
      tooltip.html(`<strong>${d.title}</strong><br>Average Salary: ${formattedSalary}`)
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", function() {
      const circle = d3.select(this).select("circle");
      circle
        .transition()
        .duration(200)
        .attr("stroke-width", 1)
        .attr("stroke-opacity", 0.15);
      
      tooltip.transition()
        .duration(500)
        .style("opacity", 0);
    });

  // 更新连接线
  updateLinks();
  updateLinkColors();
}

// === 初始化显示 ===
updateLinkColors();
updateNodeHighlights();

// 初始化背景圆圈
setTimeout(() => {
  updateProtectedZones();
  generateBackgroundCircles();
}, 0);


function rotateLabelTowardCenter(x, y, cx, cy) {
    const dx = x - cx;
    const dy = y - cy;
    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
    return angle;
}

const tooltip = d3.select("body").append("div")
  .attr("class", "tooltip")
  .style("opacity", 0);

jobNodes.on("mouseover", function(event, d) {
    const circle = d3.select(this).select("circle");
    // 高亮当前圆圈
    circle
      .transition()
      .duration(200)
      .attr("stroke-width", 2)
      .attr("stroke-opacity", 0.5);
    
    // 显示tooltip
    tooltip.transition()
      .duration(200)
      .style("opacity", 1);
    
    // 格式化薪资显示
    const formattedSalary = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(d.salary);
    
    tooltip.html(`<strong>${d.title}</strong><br>Average Salary: ${formattedSalary}`)
      .style("left", (event.pageX + 10) + "px")
      .style("top", (event.pageY - 28) + "px");
  })
  .on("mouseout", function() {
    const circle = d3.select(this).select("circle");
    // 恢复圆圈原始状态
    circle
      .transition()
      .duration(200)
      .attr("stroke-width", 1)
      .attr("stroke-opacity", 0.15);
    
    // 隐藏tooltip
    tooltip.transition()
      .duration(500)
      .style("opacity", 0);
  });

// 添加 updateLinks 函数定义（在 updateJobNodes 函数之前）
function updateLinks() {
  // 清除现有的连接线
  svg.selectAll(".link").remove();
  
  const links = [];
  
  // 添加国家到年份的连接
  years.forEach((year, yi) => {
    const yearX = centerX;
    const yearY = centerY + (yi - 2) * 75;

    countries.forEach(country => {
      const pos = polarToCartesian(centerX, centerY, radiusCountry, countryAngles(country));
      links.push({ 
        source: pos, 
        target: { x: yearX, y: yearY }, 
        sourceRadius: 10, 
        targetRadius: 20,
        color: "#555555"
      });
    });
  });

  // 添加年份到职位的连接
  if (currentJobs.length > 0) {
    years.forEach((year, yi) => {
      const yearX = centerX;
      const yearY = centerY + (yi - 2) * 75;

      currentJobs.forEach(job => {
        const pos = polarToCartesian(centerX, centerY, radiusJob, jobAngles(job.title));
        links.push({ 
          source: { x: yearX, y: yearY }, 
          target: pos, 
          sourceRadius: 20, 
          targetRadius: 32,  // 固定为32，与圆圈大小一致
          color: "#555555"
        });
      });
    });
  }

  // 绘制连接线
  svg.selectAll(".link")
    .data(links)
    .enter()
    .append("path")
    .attr("class", "link")
    .attr("stroke", d => d.color)
    .attr("data-type", d => d.color === "#555555" && d.sourceRadius === 10 ? "country-link" : "job-link")
    .attr("data-country", d => d.sourceRadius === 10 ? countries.find(c => {
      const pos = polarToCartesian(centerX, centerY, radiusCountry, countryAngles(c));
      return Math.abs(pos.x - d.source.x) < 5 && Math.abs(pos.y - d.source.y) < 5;
    }) : null)
    .attr("data-year", d => d.sourceRadius === 10 ? years.find((y, i) => {
      const yPos = centerY + (i - 2) * 75;
      return Math.abs(d.target.y - yPos) < 5;
    }) : d.sourceRadius === 20 ? years.find((y, i) => {
      const yPos = centerY + (i - 2) * 75;
      return Math.abs(d.source.y - yPos) < 5;
    }) : null)
    .attr("data-job", d => d.targetRadius > 10 && d.sourceRadius === 20 ? currentJobs.find(j => {
      const pos = polarToCartesian(centerX, centerY, radiusJob, jobAngles(j.title));
      return Math.abs(pos.x - d.target.x) < 5 && Math.abs(pos.y - d.target.y) < 5;
    })?.title : null)
    .attr("d", d => {
      const x1 = d.source.x, y1 = d.source.y;
      const x2 = d.target.x, y2 = d.target.y;
      
      const dx = x2 - x1;
      const dy = y2 - y1;
      const dist = Math.sqrt(dx * dx + dy * dy);
      
      const sourcePoint = {
        x: x1 + (dx * d.sourceRadius) / dist,
        y: y1 + (dy * d.sourceRadius) / dist
      };
      const targetPoint = {
        x: x2 - (dx * d.targetRadius) / dist,
        y: y2 - (dy * d.targetRadius) / dist
      };

      const ddx = targetPoint.x - sourcePoint.x;
      const ddy = targetPoint.y - sourcePoint.y;
      const arcFactor = d.color === "#555555" ? 2.4 : 1.5;
      const drAdjusted = Math.sqrt(ddx * ddx + ddy * ddy) * arcFactor;
      
      return `M${sourcePoint.x},${sourcePoint.y}A${drAdjusted},${drAdjusted} 0 0,1 ${targetPoint.x},${targetPoint.y}`;
    });
}

function showCustomAlert(message) {
  document.getElementById('alertMessage').textContent = message;
  document.getElementById('customAlert').style.display = 'block';
}

function closeAlert() {
  document.getElementById('customAlert').style.display = 'none';
}

function updateSalaryInfo() {
  const allJobs = (jobDataFull[selectedYear] && jobDataFull[selectedYear][selectedCountry]) 
    ? jobDataFull[selectedYear][selectedCountry] 
    : [];
    
  const highestPaidJob = allJobs.reduce((max, job) => 
    (!max || job.salary > max.salary) ? job : max
  , null);

  if (highestPaidJob) {
    const formattedSalary = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(highestPaidJob.salary);

    const line1 = `Based on available data in ${selectedYear}`;
    const line2 = `${countryNames[selectedCountry]}'s estimated highest-paid data-related position is`;
    const line3 = `<span style="color: #008000">${highestPaidJob.title}</span> with an average of around ${formattedSalary}`;
    
    const infoText = `${line1}<br>${line2}<br>${line3}`;
    document.getElementById('salaryInfo').innerHTML = infoText;
  }
}

function initializeVisualizationInfo() {
    const line1 = `Interactive visualization`;
    const line2 = `of data-related job salaries`;
    const line3 = `across countries (2020-2024)`;
    const text = `${line1}<br>${line2}<br>${line3}`;
    document.getElementById('visualizationInfo').innerHTML = text;
}

function closeJobModal() {
  document.getElementById('jobModal').style.display = 'none';
}

function showJobDetails(jobTitle) {
  const modal = document.getElementById('jobModal');
  const content = modal.querySelector('.job-modal-content');
  const jobInfo = jobDescriptions[jobTitle];

  if (!jobInfo) {
    content.innerHTML = '<div class="job-modal-title">No detailed information available for this position.</div>';
    modal.style.display = 'block';
    return;
  }

  const sections = [
    { key: 'Role_Summary', title: 'Role Summary' },
    { key: 'Key_Responsibilities', title: 'Key Responsibilities' },
    { key: 'CommonTools_Technologies', title: 'Common Tools & Technologies' },
    { key: 'Skills_Required', title: 'Required Skills' },
    { key: 'Career_Path', title: 'Career Path' }
  ];

  let html = `<div class="job-modal-title">${jobInfo.job_title}</div>`;
  
  sections.forEach(section => {
    if (jobInfo[section.key]) {
      html += `
        <div class="job-modal-section">
          <div class="job-modal-section-title">${section.title}</div>
          <div>${jobInfo[section.key]}</div>
        </div>
      `;
    }
  });

  content.innerHTML = html;
  modal.style.display = 'block';
}

// 添加点击弹窗外部关闭弹窗的功能
window.onclick = function(event) {
  const modal = document.getElementById('jobModal');
  const modalContent = modal.querySelector('.job-modal-content');
  
  // 如果点击的是模态框但不是模态框的内容区域，则关闭模态框
  if (event.target === modal || (!modalContent.contains(event.target) && event.target !== modalContent)) {
    modal.style.display = 'none';
  }
}
</script>
</body>
</html>